<html>
	<head>
		<title>invertedbox</title>
		<meta charset="UTF-8">
		<meta name="description" content="What would you think differently?">
		<meta name="keywords" content="meta">
		<meta name="author" content="Lewis Farrant">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<style>
			body { background:black; }
			
			@keyframes appear {
				0% {opacity: 0;}
				100% {opacity: 1;}
			}
			
			div {
				position:absolute;
				left:50%; top:50%; width:100vh; height:100vh;
				max-width:800px; max-height:800px;
				transform:translate(-50%, -50%);
				
				animation-name: appear;
				animation-duration: 5s;
			}
			
			@media (orientation : portrait) {
				div { width:100vw; height:100vw; }
			}
			
			canvas {
				image-rendering: optimizeSpeed;
				image-rendering: pixelated;
				height:100%;
				width:100%;
			}
			
		</style>
	</head>
	<body>
		<div>
			<a href="http://meta.invertedbox.com">Meta</a>
			<a href="http://time.invertedbox.com">Time</a>
		</div>
		<script>
			var div = document.getElementsByTagName('div')[0];
			div.innerHTML = '';
					
			function wave(v) {
				v%=6;
				if(v < 1) return v;
				if(v < 3) return 1;
				if(v < 4) return 4-v;
				return 0;
			}

			function hsl2rgb(hue, saturation, lightness) {
				return {
					red: wave(hue+2)*saturation + lightness,
					green: wave(hue)*saturation + lightness,
					blue: wave(hue+4)*saturation + lightness
				};
			}
			
			/* Build a list of objects from table format */
			function table() {
				var fields = arguments[0];
				var records = [];
				for(var r=1;r<arguments.length;r++) {
					var record = { index: r-1 };
					for(var f=0;f<fields.length;f++) {
						record[fields[f]] = arguments[r][f];
					}
					records.push(record);
				}
				return records;
			}
			
			/* Build a map from list of objects */
			function map(table, keyFunction) {
				var pairs = {};
				for(var r=0;r<table.length;r++) {
					pairs[keyFunction(table[r])] = table[r];
				}
				return pairs;
			}
			
			var branches = table(
				['name', 'color', 'link'],
				['null', '255,255,255', 'http://null.invertedbox.com'],
				['meta', '0,255,0', 'http://meta.invertedbox.com'],
				['time', '255,0,0', 'http://time.invertedbox.com'],
			);
			
			var branchesByColor = map(branches, branch => branch.color);
			
			var MATRIX_SIZE = 64;
			
			var matrix = null;
			
			var canvas = document.createElement('canvas');
			canvas.width = MATRIX_SIZE;
			canvas.height = MATRIX_SIZE;
			var context = canvas.getContext('2d');
			div.appendChild(canvas);
			
			var image = new Image(MATRIX_SIZE, MATRIX_SIZE);
			image.onload = function(){
				var imageCanvas = document.createElement('canvas');
				imageCanvas.width = MATRIX_SIZE;
				imageCanvas.height = MATRIX_SIZE;
				var imageContext = imageCanvas.getContext('2d');
				imageContext.drawImage(image, 0, 0, MATRIX_SIZE, MATRIX_SIZE);
				
				matrix = [];
				for(var x=0;x<MATRIX_SIZE;x++) {
					var row = [];
					for(var y=0;y<MATRIX_SIZE;y++) {
						var pixelData = imageContext.getImageData(x, y, 1, 1).data;
						var branch = branchesByColor[pixelData[0]+','+pixelData[1]+','+pixelData[2]];
						if(branch != null) {
							row.push(branch.index);
						} else {
							row.push(-1);
						}
					}
					matrix.push(row);
				}
				
				render();
			};
			
			var time = 0;
			
			function render() {
				time += 1/60;
				
				var branchColors = branches.map(branch => hsl2rgb(branch.index/2+time/10, 0.7, 0.3))
				
				var imageData = context.getImageData(0, 0, MATRIX_SIZE, MATRIX_SIZE);
				var i=0;
				for(var y=0;y<MATRIX_SIZE;y++) {
					for(var x=0;x<MATRIX_SIZE;x++) {
						if(matrix[x][y] == 0) {
							var xo = (x-32)/32;
							var yo = (y-32)/32;
							var distance = xo*xo + yo*yo;
							var lit = 1-distance;
							imageData.data[i++] = lit*100;
							imageData.data[i++] = lit*100;
							imageData.data[i++] = lit*100;
							imageData.data[i++] = 100;
						} else if(matrix[x][y] > 0) {
							var color = branchColors[matrix[x][y]];
							imageData.data[i++] = color.red*255;
							imageData.data[i++] = color.green*255;
							imageData.data[i++] = color.blue*255;
							imageData.data[i++] = 255;
						} else {
							imageData.data[i++] = 0;
							imageData.data[i++] = 0;
							imageData.data[i++] = 0;
							imageData.data[i++] = 0;
						}
					}
				}
				context.putImageData(imageData, 0, 0);
				requestAnimationFrame(render);
			}
			
			image.src = 'layout.png';
		</script>
	</body>
</html>
